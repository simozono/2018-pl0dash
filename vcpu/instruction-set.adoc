= 仮想CPUについて
:Author: 鹿児島大学 学術情報基盤センター 下園 幸一
:Email: <simozono@cc.kagoshima-u.ac.jp>
:doctype: article
:compat-mode!:
:source-highlighter: coderay
:icons: font
:copyright: Computing and Communications Center, Kagoshima University
:sectnums:

== 概要
本CPUは、鹿児島高専の授業「言語処理系」でコンパイラの動作を説明するために設計したCPUです。

=== メモリについて
メモリは、1番地から1000番地まであります。
1つの番地には1命令(オペランドおよびオペコードを含む)または、1つのデータが入ります。
データは整数のみです。実際のCPUでは、1つの命令が複数番地を利用したり、
1つのデータが同様に複数番地を利用したりします。
今回作成するコンパイラはメモリーを以下のように利用します。

* プログラムコード領域として、799番地まで利用します。
* ヒープ領域(大域変数領域)として、800番地から利用します。
* スタック領域は、1000番地から下がる方向に伸びていきます。

=== レジスタについて
汎用レジスタとして A, B, C の3つを持っています。
レジスタにはデータが格納される場合もありますし、番地情報が入る場合もあります。
また、後述の演算命令は、すべて、レジスタAの内容とレジスタBの内容を演算し、
演算結果をレジスタCに代入します。

汎用レジスタ以外では

* PC (プログラムカウンタ) 実行する命令の番地を格納ています。
* SP (スタックポインタ) PUSHやPOP命令等スタック操作時に利用されます。
* FP (フレームポインタ) スタックフレームを作成する場合に使用します。

があります。

== 各命令の詳細

=== 値の代入系
メモリからレジスタへの値の代入およびレジスタからメモリへの値の代入を行います。

[cols="1,3,4"]
|===
|命令|使用法|意味

.5+|MOVE
|MOVE 数字, reg1
|数字をレジスタre1に代入します。

|MOVE 数字, #(addr)
|数字を#(addr)で示されるメモリ番地に代入します。

|MOVE reg1, reg2
|レジスタreg1の値をレジスタreg2に代入します。

|MOVE reg1, #(addr)
|レジスタreg1の値を#(addr)で示されるメモリ番地に代入します。

|MOVE #(addr), reg1
|#(addr)で示されるメモリ番地の値をレジスタreg1に代入します。
|===

=== スタック操作系

スタックの動作はフルスタック(Full Stack)の下降方向(Decrement)とします。

[cols="1,3,4"]
|===
| 命令  |  使用法 | 意味

|PUSH
|PUSH reg1
|レジスタreg1の内容をスタックに積みます。
積まれる前にSP値が変化します(具体的にはSP←SP-1)。

|POP
|POP reg1
|スタックから値を取り出し、レジスタreg1に代入します。
値を取り出した後、SP値が変化します(具体的にはSP←SP+1)。

|PUSHUP
|PUSHUP
|SP値をスタック領域が増える方向に1つ変化させます(具体的にはSP←SP-1)。
|===

=== ジャンプ系

JMP, JPC,CALL命令の第1引数はジャンプ先のメモリ番地を表します。
RET命令の引数はこれらと**意味が違う**ことに注意してください。

[cols="1,3,4"]
|===
|命令|使用法|意味

|JMP
|JMP 数字
|無条件に数字番地にジャンプします。

|JPC
|JPC 数字
|レジスタCが0(偽)ならば、数字番地にジャンプします。

|CALL
|CALL 数字
|現在のPCの値 (CALL命令の番地) の次の値をスタックに積んで、
数字番地にジャンプします。

|RET
|RET 数字
|POP操作を行い、その値を帰り番地としてジャンプする。
その後、さらに第1引数の数字分だけスタック領域が減る方向にSP値が変化します
(具体的にはSP←SP+数字)。
|===

=== 算術演算子系

レジスタAの内容とレジスタBの内容で算術演算を行います。
結果はレジスタCに代入されます。

[cols="1,1,1"]
|===
|命令|使用法|意味

|PLUS |PLUS |A+B
|MINUS|MINUS|A-B
|MULTI|MULTI|A×B
|DIV  |DIV  |A÷B
|===

=== 比較演算子系

レジスタAの内容とレジスタBの内容を比較し、結果が真の場合はレジスタCが1になります。
それ以外の場合はレジスタCは0となります。
CMPODDのみがレジスタAのみで判断されます。

[cols="1,1,4"]
|===
|命令|使用法|意味

|CMPODD  |CMPODD  |Aが奇数ならば、真となります。
|CMPEQ   |CMPEQ   |AとBが同じ値ならば、真となります。
|CMPNOTEQ|CMPNOTEQ|AとBが違う値ならば、真となります。
|CMPLT   |CMPLT   |A < Bならば、真となります。
|CMPGT   |CMPGT   |A > Bならば、真となります。
|CMPLE   |CMPLE   |A <= Bならば、真となります。
|CMPGE   |CMPGE   |A >= Bならば、真となります。
|===

=== その他

[cols="1,3,4"]
|===
|命令|使用法|意味

|PRINT  |PRINT reg1|画面にreg1の内容を表示します。
|PRINTLN|PRINTLN   |画面上で改行します。
|END    |END       |プログラムが停止します。
|===
